{% extends "layout.html" %}

{% block title %}
    My Tournaments
{% endblock %}

{% block page_header %}
{# Consistent with my-decks.html header #}
<div class="flex justify-between items-center mb-4">
    <div class="flex items-center">
        <img src="{{ url_for('static', filename='img/logo.png') }}"
             alt="Logo TCG Tracker"
             class="h-10 w-10 mr-3">
        <h1 class="text-2xl font-bold text-violet-900 dark:text-violet-200">My Tournaments</h1>
    </div>
    {% if is_logged_in %}
    <a href="{{ url_for('frontend.profile_page') }}"
       aria-label="User Profile"
       class="md:hidden bg-violet-100 text-violet-700 dark:bg-violet-700 dark:text-violet-200 rounded-full p-2 shadow hover:bg-violet-200 dark:hover:bg-violet-600 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
          <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z" clip-rule="evenodd" />
        </svg>
    </a>
    {% endif %}
</div>
{% endblock %}

{% block main %}
<div class="space-y-4"> {# Add space-y-4 to match my-decks main content wrapper #}

    <section aria-labelledby="tournament-controls-heading">
        <h2 id="tournament-controls-heading" class="sr-only">Tournament Controls</h2>
        <div class="space-y-4">
            {# Mimic my-decks.html button structure #}
            <div class="flex items-center gap-4">
                <div class="sm:hidden flex-shrink-0"> {# Button to toggle filters on mobile #}
                    <button
                      id="toggle-tournament-filters-btn"
                      type="button"
                      class="w-36 inline-flex items-center justify-center px-4 py-2 border border-violet-300 dark:border-violet-600 rounded-md shadow-sm text-sm font-medium text-violet-900 dark:text-violet-200 bg-violet-100 dark:bg-violet-700 hover:bg-violet-50 dark:hover:bg-violet-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2 text-violet-500 dark:text-violet-400">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                      </svg>
                      <span id="toggle-tournament-filters-text">Sort & Filter</span>
                    </button>
                </div>

                <div class="flex-grow">
                    <a href="{{ url_for('tournaments.create_tournament') }}"
                      role="button"
                      class="block w-full text-center bg-violet-700 hover:bg-violet-600 text-white text-sm font-medium py-2 px-4 rounded-lg shadow-sm transition border border-transparent">
                      New Tournament
                    </a>
                </div>
            </div>

            {# Filter Controls - styled more like my-decks.html containers #}
            <div id="tournament-filter-controls-container" class="hidden md:grid md:grid-cols-2 lg:grid-cols-3 gap-4 bg-white dark:bg-gray-800 shadow-md rounded-xl border border-violet-200 dark:border-gray-700 p-4">
                <div>
                    <label for="sort_tournaments" class="block text-sm font-medium text-violet-900 dark:text-violet-300 mb-1">Sort by</label>
                    <select id="sort_tournaments" name="sort_by"
                      class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-violet-500 focus:ring focus:ring-violet-500 focus:ring-opacity-50 text-sm py-2 pl-3 pr-10">
                      <option value="event_date_desc" {% if current_sort_by == 'event_date' and current_sort_order == 'desc' %}selected{% endif %}>Event Date (Newest)</option>
                      <option value="event_date_asc" {% if current_sort_by == 'event_date' and current_sort_order == 'asc' %}selected{% endif %}>Event Date (Oldest)</option>
                      <option value="name_asc" {% if current_sort_by == 'name' and current_sort_order == 'asc' %}selected{% endif %}>Name (A-Z)</option>
                      <option value="name_desc" {% if current_sort_by == 'name' and current_sort_order == 'desc' %}selected{% endif %}>Name (Z-A)</option>
                      <option value="created_at_desc" {% if current_sort_by == 'created_at' and current_sort_order == 'desc' %}selected{% endif %}>Date Added (Newest)</option>
                    </select>
                </div>
                <div>
                    <label for="filter_status" class="block text-sm font-medium text-violet-900 dark:text-violet-300 mb-1">Status</label>
                    <select id="filter_status" name="status"
                      class="w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 shadow-sm focus:border-violet-500 focus:ring focus:ring-violet-500 focus:ring-opacity-50 text-sm py-2 pl-3 pr-10">
                      <option value="">All Statuses</option>
                      <option value="Planned" {% if current_status_filter == 'Planned' %}selected{% endif %}>Planned</option>
                      <option value="Active" {% if current_status_filter == 'Active' %}selected{% endif %}>Active</option>
                      <option value="Completed" {% if current_status_filter == 'Completed' %}selected{% endif %}>Completed</option>
                      <option value="Cancelled" {% if current_status_filter == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                {# Add more filters like Format if needed, styled similarly #}
            </div>
        </div>
    </section>

    <section aria-labelledby="tournament-list-heading">
        <h2 id="tournament-list-heading" class="sr-only">My Organized Tournaments</h2>
        {% if organized_tournaments %}
        <div id="tournaments-container" class="grid gap-4 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3">
            {% for tournament in organized_tournaments %}
            <a href="{{ url_for('tournaments.view_tournament', tournament_id=tournament.id) }}"
               class="block bg-white dark:bg-gray-800 shadow-lg hover:shadow-xl transition-shadow duration-200 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden group">
                <div class="p-5">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-100 group-hover:text-violet-700 dark:group-hover:text-violet-400 transition-colors">
                            {{ tournament.name | truncate(40) }}
                        </h3>
                        <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full
                            {% if tournament.status == 'Planned' %} bg-blue-100 text-blue-800 dark:bg-blue-700 dark:text-blue-100
                            {% elif tournament.status == 'Active' %} bg-green-100 text-green-800 dark:bg-green-700 dark:text-green-100
                            {% elif tournament.status == 'Completed' %} bg-gray-200 text-gray-700 dark:bg-gray-600 dark:text-gray-100
                            {% elif tournament.status == 'Cancelled' %} bg-red-100 text-red-800 dark:bg-red-700 dark:text-red-100
                            {% else %} bg-yellow-100 text-yellow-800 dark:bg-yellow-700 dark:text-yellow-100
                            {% endif %}">
                            {{ tournament.status }}
                        </span>
                    </div>

                    <div class="space-y-1 text-sm text-gray-600 dark:text-gray-300">
                        <p>
                            <span class="font-medium text-gray-700 dark:text-gray-200">Date:</span>
                            {{ tournament.event_date.strftime('%b %d, %Y %I:%M %p %Z') if tournament.event_date else 'Not set' }}
                        </p>
                        {% if tournament.format %}
                        <p>
                            <span class="font-medium text-gray-700 dark:text-gray-200">Format:</span>
                            {{ tournament.format }}
                        </p>
                        {% endif %}
                        <p>
                            <span class="font-medium text-gray-700 dark:text-gray-200">Players:</span>
                            {{ tournament.participants.count() }}{% if tournament.max_players %}<span class="text-gray-500 dark:text-gray-400"> / {{ tournament.max_players }}</span>{% else %}<span class="text-gray-400"> / ∞</span>{% endif %}
                        </p>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-750 px-5 py-3 border-t border-gray-100 dark:border-gray-650">
                    <p class="text-xs text-violet-600 dark:text-violet-400 font-medium text-right">View Details →</p>
                </div>
            </a>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 bg-white dark:bg-gray-800 shadow-lg rounded-xl border border-gray-200 dark:border-gray-700 mt-6">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
            </svg>
            <h3 class="mt-2 text-sm font-semibold text-gray-900 dark:text-gray-100">No tournaments organized yet</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Get started by creating a new tournament.</p>
            <div class="mt-6">
                <a href="{{ url_for('tournaments.create_tournament') }}"
                   class="inline-flex items-center bg-violet-600 hover:bg-violet-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-offset-2 transition duration-150 ease-in-out">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2 -ml-1">
                        <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" />
                    </svg>
                    New Tournament
                </a>
            </div>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
        // Basic JS for sort/filter controls to reload the page with query parameters
        document.addEventListener('DOMContentLoaded', function () {
            const sortSelect = document.getElementById('sort_tournaments');
            const statusFilterSelect = document.getElementById('filter_status');
            const toggleFiltersBtn = document.getElementById('toggle-tournament-filters-btn');
            const filtersContainer = document.getElementById('tournament-filter-controls-container');

            function updateQueryAndReload() {
                const params = new URLSearchParams(window.location.search);

                if (sortSelect && sortSelect.value) {
                    const [sortBy, sortOrder] = sortSelect.value.split('_');
                    params.set('sort_by', sortBy);
                    params.set('sort_order', sortOrder);
                } else {
                    params.delete('sort_by');
                    params.delete('sort_order');
                }

                if (statusFilterSelect && statusFilterSelect.value) {
                    params.set('status_filter', statusFilterSelect.value);
                } else {
                    params.delete('status_filter');
                }

                window.location.search = params.toString();
            }

            if (sortSelect) {
                sortSelect.addEventListener('change', updateQueryAndReload);
            }
            if (statusFilterSelect) {
                statusFilterSelect.addEventListener('change', updateQueryAndReload);
            }

            // Toggle filter visibility on mobile
            if (toggleFiltersBtn && filtersContainer) {
                // Check if filters are active based on URL params to show container by default
                const urlParamsForToggle = new URLSearchParams(window.location.search);
                if (urlParamsForToggle.has('sort_by') || urlParamsForToggle.has('status_filter')) {
                    if (window.innerWidth < 768) { // Only for mobile
                        filtersContainer.classList.remove('hidden');
                        filtersContainer.classList.add('grid'); // Use grid for mobile if it was hidden
                         // Update button text or style if needed
                    }
                }

                toggleFiltersBtn.addEventListener('click', () => {
                    filtersContainer.classList.toggle('hidden');
                    filtersContainer.classList.toggle('grid'); // Or 'block' if you prefer for mobile
                    // Optionally change button text/icon
                    const isHidden = filtersContainer.classList.contains('hidden');
                    // Example: toggleFiltersBtn.querySelector('span').textContent = isHidden ? 'Sort & Filter' : 'Hide Filters';
                });
            }

            // Set initial values for selects based on URL params (if any)
            const urlParams = new URLSearchParams(window.location.search);
            const currentSortBy = urlParams.get('sort_by');
            const currentSortOrder = urlParams.get('sort_order');
            const currentStatusFilter = urlParams.get('status_filter');

            if (sortSelect && currentSortBy && currentSortOrder) {
                sortSelect.value = `${currentSortBy}_${currentSortOrder}`;
            }
            if (statusFilterSelect && currentStatusFilter) {
                statusFilterSelect.value = currentStatusFilter;
            }
        });
    </script>
{% endblock %}